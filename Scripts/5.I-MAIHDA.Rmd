---
title: "I-MAHDA"
author: "Ruth CE Bowyer"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  github_document:
    toc: true
    toc_depth: 3
---


```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
```

## **0.Overview**

This script has been modified with thanks from that provided as supplementary material in the following paper: 

*Evans, C.R., G. Leckie, S.V. Subramanian, A. Bell, & J. Merlo. (2024.). A Tutorial for Conducting Intersectional Multilevel Analysis of Individual Heterogeneity and Discriminatory Accuracy (MAIHDA). SSM - Population Health https://doi.org/10.1016/j.ssmph.2024.101664*



```{r message = F, warning =F}
library(tidyverse)
library(ggeffects)
library(lme4)
library(merTools)
library(labelled)
library(sjPlot)
library(Metrics)
```



## **1.Data**


```{r include=FALSE}
dd <- "~/Library/CloudStorage/OneDrive-King'sCollegeLondon/Working_projects/Tap.water/SharedDSRB/Data/"

```



```{r data}


watdf <- read.csv(paste0(dd, "I1194/water.consump.filter.with.employ.tds.01.08.2025.csv")) # File derived as output from script 3. This csv file has been filtered in Script 1, and then mapped to employment data in script 3. 

### Add in details on ethnicity, education, IMD
add <-  read.csv(paste0(dd,"TUKsocioeconomics_from_descriptives_2021_eth_edu_imd.csv"))
add$X <- NULL
watdf <- merge(watdf, add, by.x="study_no", by.y="sn",all.x=T)


```

Recode the additional varaibles 

```{r}
watdf$Ethnic_Origin <- ifelse(is.na(watdf$ethnicity_cat_combined), NA, ifelse(watdf$ethnicity_cat_combined== "White", 1, 2))
watdf$SEX <- ifelse(is.na(watdf$SEX), NA, ifelse(watdf$SEX=="F",1,2))
watdf$Agein2022.gr <- ifelse(is.na(watdf$Agein2022), NA, 
                           ifelse(watdf$Agein2022.gr == "1.Under60", 1, ifelse(watdf$Agein2022.gr == "2.60-71", 2,3)))
watdf$Employ_bin <- ifelse(is.na(watdf$Employ_bin), NA, ifelse(watdf$Employ_bin=="NotRetired",1,2))
watdf$edu_bin_combined <- ifelse(is.na(watdf$edu_bin_combined), NA, ifelse(watdf$edu_bin_combined=="All else",1,2))


```

### Stratum derivation

```{r}

# Generate the stratum ID
watdf$stratum <-  10000*watdf$SEX + 1000*watdf$Ethnic_Origin + 100*watdf$Employ_bin + 
                10*watdf$edu_bin_combined + 1*watdf$Agein2022.gr

# Turn the stratum identifier into a factor variable
watdf$stratum <- as.factor(watdf$stratum)

# reattach factor labels from original Stata dataset
watdf <- unlabelled(watdf)

# sort data by stratum
watdf <- watdf[order(watdf$stratum),]

# tabulate stratum
table(watdf$stratum)


```

```{r}
# Generate a new variabe which records stratum size
watdf <- watdf %>%
  group_by(stratum) %>%
  mutate(strataN = n())
```


Subsetting to strata where n > 5

```{r}
watdfx <- subset(watdf, strataN > 5)
```

Running as a complete case analysis for stratum and water consumption

```{r}
watdfx <- subset(watdfx, !is.na(stratum))
watdfx <- subset(watdfx, !is.na(total.consump.L))
```


**The following analysis is therefore run on this many individuals:**

```{r}
nrow(watdfx)
```


### **Estimate linear model 1A**

```{r}

# Fit the two-level linear regression with no covariates
model1A <- lmer(total.consump.L ~ (1|stratum), data=watdfx)
summary(model1A)

# This produces a model output showing the level 2 variance (or, alternatively,
# it's standard deviation) and the same for level 1 (labelled 
# "stratum (Intercept)" and "Residual", respectively)

# predict the mean outcome
watdfx$m1Am <- predict(model1A)
# Calculated as the fixed-portion linear prediction plus contributions based on 
# predicted random effects.

```


### **Estimate Linear model 1B**

```{r}
# Fit the two-level linear regression with covariates
model1B <- lmer(total.consump.L ~ SEX + Ethnic_Origin + Employ_bin + edu_bin_combined + Agein2022.gr + (1|stratum), 
                data=watdfx)
summary(model1B)

# predict the mean outcome and confidence intervals of prediction
m1Bm <- predictInterval(model1B, level=0.95, include.resid.var=FALSE)
# note that, unlike the stata code, this code combines the fixed and random part
# uncertainty. This saves a step later in comparison to the stata code. It also
# creates a new dataframe for these predictions, with one row per stratum.

# Create an identifier variable in the new dataframe, called "id"
m1Bm <- mutate(m1Bm, id=row_number())

# predict the stratum random effects and associated SEs
m1Bu <- REsim(model1B)
```


### create a data frame at the strata level (with the means of each variable)

```{r}
# first, merge predictions with original data

# create an id variable for merging in the watdf dataframe
watdfx$id <- seq.int(nrow(watdfx))

# create a new dataframe, watdf2, that merges watdf and m1Bm
watdf2 <- merge(watdfx, m1Bm, by="id")

# rename the variables from m1Bm
watdf2 <- watdf2 %>%
  rename(
    m1Bmfit=fit,
    m1Bmupr= upr,
    m1Bmlwr=lwr
  )


# Collapse the data down to a stratum-level dataset 
stratum_level <- aggregate(x=watdf2[c("total.consump.L")], 
                  by=watdf2[c("SEX", "Ethnic_Origin", "Employ_bin", "edu_bin_combined", "Agein2022.gr",
                  "stratum", "strataN", "m1Am", "m1Bmfit", "m1Bmupr", "m1Bmlwr")],
                  FUN=mean)

```


### **Calculate stratum-level descriptive statistics**
As in table 2 in Evans et al., 

```{r}
# generate binary indicators for whether each stratum has more than X individuals
summary(stratum_level$strataN)
stratum_level$n100plus <- ifelse(stratum_level$strataN>=100, 1,0)
stratum_level$n50plus <- ifelse(stratum_level$strataN>=50, 1,0)
stratum_level$n30plus <- ifelse(stratum_level$strataN>=30, 1,0)
stratum_level$n20plus <- ifelse(stratum_level$strataN>=20, 1,0)
stratum_level$n10plus <- ifelse(stratum_level$strataN>=10, 1,0)
stratum_level$nlessthan10 <- ifelse(stratum_level$strataN<10, 1,0)

# tabulate the binary indicators
table(stratum_level$n100plus)
table(stratum_level$n50plus)
table(stratum_level$n30plus)
table(stratum_level$n20plus)
table(stratum_level$n10plus)
table(stratum_level$nlessthan10)
```

```{r}
# summmarise the observed stratum means
summary(stratum_level$total.consump.L)
sd(stratum_level$total.consump.L)
#Note: mean of the observed stratum means = "grand mean"
```

```{r}
# summarise the predicted stratum means
summary(stratum_level$m1Am)
sd(stratum_level$m1Am)
#Note: mean of the predicted stratum means = "precision weighted grand mean"
```

### **Create a table that includes all model estimates, including the Variance**

As in **Table 3** of Evans et al


```{r}
# Create a table that includes all model estimates, including the Variance 
# Partitioning Coefficients (VPC)
tab_model(model1A, model1B, p.style="stars")
```

Calculate the Proportional Change in Variance (PCV) (as a percentage) for model 1

```{r}

# first extract variance matrices from the model object
vc1a <-as.data.frame(VarCorr(model1A))
vc1b <-as.data.frame(VarCorr(model1B))

# calculate PCVs using components of these variance matrices (as percentages)
PCV1 <- ((vc1a[1,4] - vc1b[1,4]) / vc1a[1,4])*100
PCV1
```



## **Figures**

### Sample distribution

```{r}
# panel A - histogram of the individual outcome
mean = round(mean(watdfx$total.consump.L),2)
#min = min(stratum_level$total.consump.L)
#max = max(stratum_level$total.consump.L)

ggplot(watdf, aes(x=total.consump.L)) + 
  geom_histogram(aes(y = after_stat(count / sum(count))), binwidth=0.2) + 
  scale_y_continuous(labels=scales::percent) +
  ylab("Percent of Individuals") + xlab("water cosumption L/day") +
  geom_vline(aes(xintercept=mean)) + #this is the sample mean
  annotate("text", x=mean, y=0.1, label= paste0("Sample Mean=", mean, " L/day"))
```


### histogram of the observed stratum means

```{r}
# Panel B - histogram of the observed stratum means
mean = round(mean(stratum_level$total.consump.L),2)

ggplot(stratum_level, aes(x=total.consump.L)) + 
  geom_histogram(aes(y = after_stat(count / sum(count))), binwidth=0.2) + 
  scale_y_continuous(labels=scales::percent) +
  ylab("Percent of Strata")  +
  geom_vline(aes(xintercept=mean)) + #this is the sample mean
  annotate("text", x=mean, y=0.5, label= paste0("Grand Mean=", mean, " L/day")) 
```

###  histogram of the predicted stratum means

```{r}

mean = round(mean(stratum_level$m1Am),2)

ggplot(stratum_level, aes(x=m1Am)) + 
  geom_histogram(aes(y = after_stat(count / sum(count))), binwidth=0.2) + 
  scale_y_continuous(labels=scales::percent) +
  ylab("Percent of Strata") +
  xlab("Predicted total.consump.L") +
 geom_vline(aes(xintercept=mean))+ #this is the precision weighted grand mean
     annotate("text", x=mean, y=0.9, 
        label=paste0("Precision Weighted Grand Mean=",mean," L/day"))

#  annotate("text", x=34, y=0.03, label="Min =
#           34.2 mmol/mol") +
#  annotate("text", x=48.2, y=0.03, label="Max =
 #          48.1 mmol/mol")
```

```{r}

# Rank the predicted stratum means
stratum_level <- stratum_level %>%
  mutate(rank=rank(m1Bmfit))


```

### Stratum ranking

```{r}

# Panel A - Plot the caterpillar plot of the predicted stratum means
# use predictions and uncertainty generated previously
ggplot(stratum_level, aes(y=m1Bmfit, x=rank)) +
  geom_point() +
  geom_pointrange(aes(ymin=m1Bmlwr, ymax=m1Bmupr)) +
  ylab("Water consumption, Model 1B") +
  xlab("Stratum Rank") + 
  theme_bw()

```

```{r}

# Generate list of 6 highest and 6 lowest predicted stratum means (for Table 4)
stratum_level <- stratum_level[order(stratum_level$rank),]

#Relabel to have each level as text label
x <- stratum_level$Ethnic_Origin
stratum_level$Ethnic_Origin <- ifelse(x==1, "White", "RacialisedInUK")

x <- stratum_level$SEX
stratum_level$SEX <- ifelse(x==1, "Female", "Male")

x <- stratum_level$Agein2022.gr 
stratum_level$Agein2022.gr <- ifelse(x == 1, "1.Under60", 
                                     ifelse(x == 2 ,"2.60-71", "71+"))

x <- stratum_level$Employ_bin
stratum_level$Employ_bin <- ifelse(x == 1, "Employed", "Retired_NotEmployed")

x <- stratum_level$edu_bin_combined
stratum_level$edu_bin_combined <- ifelse(x==1, "All else", "Degree_or_equiv")


head(stratum_level)
tail(stratum_level)
```
Write for results

```{r include=F}

write.csv(stratum_level, paste0(dd, "/I1194/Stratum_level_ranked_IMAIHDA-results.csv", row.names=F))

```


### Random effects

This does not fit well for our data

```{r}
# repeating step from above - generate u0j values and uncertainty
m1Bu <- REsim(model1B)

# Plot the caterpillar plot of the predicted stratum random effects
p <-plotREsim(m1Bu) +
  xlab("Stratum Rank") +
  ylab("Predicted stratum Random Effect in total.consump.L") +
  ggtitle("") +
  theme(
    strip.background=element_blank(),
    strip.text.x = element_blank()
  )
p

```


```{r}
# Here we use the data embedded in the ggplot p object above, since it has 
# already created what we need to subset the data.

m1Bucut <- p[["data"]]

# filter the data based on significance
m1Bucut <- m1Bucut %>%
  filter(sig=="TRUE") %>%
  mutate(xvar=as.factor(xvar))

# plot the caterpillar plot of the significant predicted stratum random effects
ggplot(m1Bucut, aes(x=xvar, y=median, label=groupID)) +
  geom_point(size=3) +
  geom_pointrange(aes(ymin=ymin, ymax=ymax)) + 
  geom_hline(yintercept=0, color="red", linewidth=1) +
  geom_text(hjust=0, vjust=5) +
  xlab("Stratum Rank") +
  ylab("Predicted stratum Random Effect in total.consump.L (mmol/mol)") +
  theme_bw()

```
