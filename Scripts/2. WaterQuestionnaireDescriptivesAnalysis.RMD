---
title: "**Water Questionnaire 2 - Cleaning - Descriptives - Analysis**"
author: "Daniel Schillereff and Ruth CE Bowyer"
date: "`r format(Sys.Date())`"
output: 
  github_document:
    toc: true
    toc_depth: 3
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## **0. About**

This script is to clean and derive descriptive statistics from the TwinsUK Water Consumption Questionnaire



```{r libs, message = F, warning=FALSE}

rm(list=ls())

library(tidyverse)
library(ggplot2)
library(readxl)
library(rstatix)
library(FSA)
library(halfmoon)
library(RColorBrewer)
library(ggpubr)



#checking




```


## **1. Data**


```{r include=FALSE}
dd <- "~/Library/CloudStorage/OneDrive-King'sCollegeLondon/Working_projects/Tap.water/SharedDSRB/Data/I1194"

```



```{r data}

## Define the data directory -- actual directory omitted for security
#dd <- ~/path/to/data

# Water questionnaire data 
df.q <- read_xlsx(paste0(dd,"/DS00070_WaterConsumptionStudy_Questionnaire/WaterConsumptionStudyQuestionnaire_Data.xlsx"))

#Response codes 
Responses <- read_xlsx(paste0(dd,"/DS00070_WaterConsumptionStudy_Questionnaire/WaterConsumptionStudyQuestionnaire_Data.xlsx"), sheet=2)

## Create a df with q code - row names qcode 
Qframe <- as.data.frame(t(df.q[1,]))
## Add col index for easy referencing
names(Qframe) <- "Question"
Qframe$col_index <- 1:ncol(df.q)

##Clean up df.q to remove these rows
df.q <- df.q[-1,]
df.q <- as.data.frame(df.q)


TDs <- read_excel(paste0(dd, "/TwinDetails.xlsx")) # Data on age, sex, ethnicity, zygosity 
water.consump <- read.csv(paste0(dd, "/water.consump.filter.2025.07.28.csv")) # File derived as output from script 1. This csv file has been filtered in Script 1. 

```


## **2. Descriptives - by question**



### **2a. Figure of amount consumed in general**

```{r warning = F}
#Filter df.q to 3SDs
df.q <- df.q %>%
  filter(ParticipantID %in% water.consump$study_no)

qs <- df.q[c("q2_a", "q2_b", "q2_d", "q2_e")]

q2s <- as.data.frame(apply(qs,2, function(x){
  x <- as.factor(x)
  levels(x) <-  c("0.Never/Rarely", "1.Once a day", "2.Twice a day", "3.Three times a day", "4.Four times a day", "5.Five times a day", "6.Six times a day", "7.Seven times a day", NA)
  return(x)
}))


q2ss <- pivot_longer(
    q2s, 
    cols = `q2_a`:`q2_e`, 
      names_to = "Question",
      values_to = "Times_per_day", 
    cols_vary = "slowest",
      ) 

q2ss <- q2ss %>% 
    mutate(Times_per_day = Times_per_day %>% fct_relevel("7.Seven times a day", "6.Six times a day", "5.Five times a day", "4.Four times a day", "3.Three times a day", "2.Twice a day", "1.Once a day", "0.Never/Rarely"))

q2ss$Times_per_day %>% levels()

labels <- as_labeller(c('q2_a' = "Small glass (200 mL)", 'q2_b' = "Large glass (500 mL)", 'q2_d' = "Small mug (325 mL)", 'q2_e' = "Large mug (440 mL)"))

labels.times <- setNames(c("No response", "Rarely or never", "One", "Two", "Three", "Four", "Five", "Six", "Seven or more"), c(NA, "0.Never/Rarely", "1.Once a day", "2.Twice a day", "3.Three times a day", "4.Four times a day", "5.Five times a day", "6.Six times a day", "7.Seven times a day"))
```


```{r}
Fig1 <- ggplot(q2ss, aes(y = Times_per_day)) +
    geom_bar(stat = "count") +
    theme_bw() + 
    ylab('Number of times consumed a day') +
    xlab('Number of respondents') +
    scale_y_discrete(labels = labels.times) +
    theme(axis.text=element_text(size=11), axis.title=element_text(size=14)) +
    facet_grid(. ~ Question, labeller=labeller(Question = labels), scales = "free") +
    theme(strip.text.x = element_text(size = 12))

Fig1
```

```{r}
#Most and fewest drinks per day
number.glasses <- subset(qs, q2_a == "7" & q2_b == "7")
qs$q2_a_numeric <- as.numeric(qs$q2_a)
qs$q2_b_numeric <- as.numeric(qs$q2_b)
number.glasses.12 <- subset(qs, q2_a_numeric + q2_b_numeric == 12)
number.glasses.13 <- subset(qs, q2_a_numeric + q2_b_numeric == 13)
number.glasses.14 <- subset(qs, q2_a_numeric + q2_b_numeric == 14)
number.glasses.12 <- subset(qs, q2_a == "6" & q2_b == "6"| q2_a == "7" & q2_b == "7")
number.mugs <- subset(qs, q2_d == "3" | q2_d == "4" | q2_e == "3" | q2_e == "4")
mugs.zero <- subset(qs, q2_d > "0" | q2_e > "0")
glasses.mugs.zero <- subset(qs, q2_a == "0" & q2_b == "0" & q2_d == "0" & q2_e == "0")

```



### **2b. Behaviour around water filtering**

```{r}

q5 <- df.q[c("q5")]

df.q5 <- as.data.frame(q5)

q5.yes <- sum(df.q5 == "1", na.rm=TRUE)
q5.no <- sum(df.q5 == "0", na.rm=TRUE)

#percentage who filter their water
q5.perc <- 616/2710*100

#Does the respondent filter water for cold drinks, hot drinks or when cooking?
q6 <- df.q[c("q6_a", "q6_b", "q6_c")]

sum(q6 == "999906", na.rm=TRUE)

#percentage who always filter their water for hot, cold, cooking
q6.hot <- sum(q6$q6_a == "4", na.rm=TRUE)
q6.cold <- sum(q6$q6_b == "4", na.rm=TRUE)
q6.cooking <- sum(q6$q6_c == "4", na.rm=TRUE)

q6.hot.perc <- 351/2710*100
q6.cold.perc <- 339/2710*100
q6.cooking.perc <- 132/2710*100

#percentage who never filter their water for hot, cold, cooking
q6.hot.never <- sum(q6$q6_a == "0", na.rm=TRUE)
q6.cold.never <- sum(q6$q6_b == "0", na.rm=TRUE)
q6.cooking.never <- sum(q6$q6_c == "0", na.rm=TRUE)

q6.hot.never.perc <- 71/2710*100
q6.cold.never.perc <- 141/2710*100
q6.cooking.never.perc <- 302/2710*100

q6s <- as.data.frame(apply(q6,2, function(x){
  x <- as.factor(x)
  levels(x) <-  c("None of the time", "Some of the time", "Half of the time", "Most of the time", "All of the time", NA, "Skipped")
  return(x)
}))

sum(q6s == "All of the time", na.rm=TRUE)

q6ss <- pivot_longer(
    q6s, 
    cols = `q6_a`:`q6_c`, 
      names_to = "Question",
      values_to = "How_often", 
    cols_vary = "slowest",
      ) 

q6ss <- q6ss %>% 
    mutate(How_often = How_often %>% fct_relevel("All of the time", "Most of the time", "Half of the time", "Some of the time", "None of the time"))

q6ss$How_often %>% levels()

labels <- as_labeller(c('q6_a' = "Cold drinks", 'q6_b' = "Hot drinks", 'q6_c' = "Cooking"))
```

```{r}

FigS11 <- ggplot(q6ss, aes(y = How_often)) +
    geom_bar(stat = "count") +
    theme_bw() + 
    ylab('How often do respondents use a water filter') +
    xlab('Number of respondents') +
    theme(axis.text=element_text(size=11), axis.title=element_text(size=14)) +
    facet_grid(. ~ Question, labeller=labeller(Question = labels), scales = "free") +
    theme(strip.text.x = element_text(size = 12))

FigS11


```



### **2c. Water consumption by age**

```{r}
water.c.demo <- merge(water.consump, TDs, by.x=c("study_no"), by.y = "ParticipantID")
water.c.demo$age <- 2022 - water.c.demo$YearOfBirth

water.c.demo$age.gr <- ifelse(water.c.demo$age>=45&water.c.demo$age<=65, "2. 45 - 65",
                              ifelse(water.c.demo$age>65, "3.Over 65", "1. Under 45"))

### 
dpt <- water.c.demo %>% 
  summarise(n=length(age),
            AGE.Mean = mean(age, na.rm = T),
            Age.Median = median(age, na.rm = T),
            AGE.SD = sd(age, na.rm = T),
            SEX.n.Fem = sum(SEX=="F",na.rm = T),
            SEX.Perc.Fem = sum(SEX=="F",na.rm = T)/length(SEX)*100,
            ZYG.n.MZ = sum(ACTUAL_ZYGOSITY=="MZ",na.rm = T),
            ZYG.Perc.MZ = sum(ACTUAL_ZYGOSITY=="MZ",na.rm=T)/length(ACTUAL_ZYGOSITY)*100,
            ETH.n.White = sum(Ethnic_Origin=="White",na.rm = T),
            ETH.Perc.White = sum(Ethnic_Origin=="White",na.rm = T)/length(Ethnic_Origin)*100)
      

dpt2 <- as.data.frame(t(dpt))

dpt2  

drink.age <- water.c.demo%>%
                    group_by(age.gr)%>% 
                    summarise(Mean=mean(total.drink.L), Max=max(total.drink.L), Min=min(total.drink.L), Median=median(total.drink.L), Std=sd(total.drink.L))

labels.Age <- setNames(c("Under 45", "45-65", "Over 65"), c("1. Under 45", "2. 45 - 65", "3.Over 65"))

#Violin plot of drinking consumption by age
FigS1A <- ggplot(water.c.demo, aes(age.gr, total.drink.L, fill = age.gr)) + geom_violin() + theme_bw() + scale_y_continuous(limits = c(0, 6.2)) + scale_x_discrete(labels = labels.Age) + ylab("Daily water consumption from drinking (L)") + xlab("") + 
  scale_fill_brewer(palette = "Dark2") +
  #annotate("text", x = 0.5, y = 6, label = c("A"), colour = "black", size = 8) +
  theme(legend.position="none") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=14)) +
  annotate("text", x = 0.5, y = 6, label = c("A"), colour = "black", size = 8) +
  geom_segment(aes(x = 0.9, y = 2.12, xend = 1.1, yend = 2.12), linewidth = 3, colour = "#006400") +  
  geom_segment(aes(x = 1.9, y = 2.38, xend = 2.1, yend = 2.38), linewidth = 3, colour = "#8B4500") +
  geom_segment(aes(x = 2.9, y = 2.28, xend = 3.1, yend = 2.28), linewidth = 3, colour = "#9370DB") + geom_hline(yintercept = 2.7, linetype="dashed")  + geom_hline(yintercept = 3.7, linetype="dashed") +  
  annotate("text", x = c(1.45, 2.4), y = c(0.75, 5.5), label = c("Recommended \n daily intake \n for women \n (2.7 L)", "Recommended \n daily intake \n for men  \n (3.7 L)")) +
  annotate('curve',x = 1.25,y = 1.42, yend = 2.65, xend = 1.2, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))  ) +
  annotate('curve', x = 2.45,y = 4.8, yend = 3.8, xend = 2.4, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))  )

FigS1A

pairwise.wilcox.test(water.c.demo$total.drink.L, water.c.demo$SEX)

stat.test <- water.c.demo %>% 
  wilcox_test(total.drink.L ~ SEX) %>%
  add_significance()
stat.test

#Hot drink consumption by sex and age
total.hot.L.F <- subset(water.c.demo, water.c.demo$SEX == "F")
median(total.hot.L.F$total.hot.drink.L)
mean(total.hot.L.F$total.hot.drink.L)
total.hot.L.M <- subset(water.c.demo, water.c.demo$SEX == "M")
median(total.hot.L.M$total.hot.drink.L)
mean(total.hot.L.M$total.hot.drink.L)

total.hot.L.over65 <- subset(water.c.demo, water.c.demo$age.gr == "3.Over 65")
median(total.hot.L.over65$total.hot.drink.L)
mean(total.hot.L.over65$total.hot.drink.L)
total.hot.L.45.65 <- subset(water.c.demo, water.c.demo$age.gr == "2. 45 - 65")
median(total.hot.L.45.65$total.hot.drink.L)
mean(total.hot.L.45.65$total.hot.drink.L)
total.hot.L.under45 <- subset(water.c.demo, water.c.demo$age.gr == "1. Under 45")
median(total.hot.L.under45$total.hot.drink.L)
mean(total.hot.L.under45$total.hot.drink.L)

```

```{r ## Age as terciles}
water.c.demo$Agein2022 <- 2022 - water.c.demo$YearOfBirth

water.c.demo.subset <- subset(water.c.demo, Agein2022 > 18)
age.tercile <- quantile(water.c.demo.subset$Agein2022, probs=c(1/3,2/3,1))

water.c.demo.subset$Agein2022.group <- ifelse(water.c.demo.subset$Agein2022>=70,"3.70+",
                    ifelse(water.c.demo.subset$Agein2022>=57, "2.57-70",
                           ifelse(water.c.demo.subset$Agein2022<57, "1.Under57",NA)))


water.c.demo.subset$Agein2022.group <- as.factor(water.c.demo.subset$Agein2022.group)
table(water.c.demo.subset$Agein2022.group)

drink.tercile <- water.c.demo.subset%>%
                    group_by(Agein2022.group)%>% 
                    summarise(Mean=mean(total.drink.L), Max=max(total.drink.L), Min=min(total.drink.L), Median=median(total.drink.L), Std=sd(total.drink.L))

kruskal.test(total.drink.L ~ Agein2022.group, data = water.c.demo.subset)
pairwise.wilcox.test(water.c.demo.subset$total.drink.L, water.c.demo.subset$Agein2022.group)

labels.Age.Tercile <- setNames(c("<57", "57-70", "70+"), c("1.Under57", "2.57-70", "3.70+"))

FigS1B <- ggplot(water.c.demo.subset, aes(Agein2022.group, total.drink.L, fill = Agein2022.group)) + geom_violin() + theme_bw() + scale_y_continuous(limits = c(0, 6.2)) + scale_x_discrete(labels = labels.Age.Tercile) + ylab("Daily water consumption from drinking (L)") + xlab("") + 
  scale_fill_brewer(palette = "Dark2") +
  annotate("text", x = 0.5, y = 6, label = c("B"), colour = "black", size = 8) +
  theme(legend.position="none") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=14)) +
  geom_segment(aes(x = 0.9, y = 2.19, xend = 1.1, yend = 2.19), linewidth = 3, colour = "#006400") +  
  geom_segment(aes(x = 1.9, y = 2.36, xend = 2.1, yend = 2.36), linewidth = 3, colour = "#8B4500") +
  geom_segment(aes(x = 2.9, y = 2.35, xend = 3.1, yend = 2.35), linewidth = 3, colour = "#9370DB") +
 geom_hline(yintercept = 2.7, linetype="dashed")  + geom_hline(yintercept = 3.7, linetype="dashed") +  
  annotate("text", x = c(1.45, 2.4), y = c(0.75, 5.5), label = c("Recommended \n daily intake \n for women \n (2.7 L)", "Recommended \n daily intake \n for men  \n (3.7 L)")) +
  annotate('curve',x = 1.25,y = 1.42, yend = 2.65, xend = 1.2, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))  ) +
  annotate('curve', x = 2.45,y = 4.8, yend = 3.8, xend = 2.4, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))  )

FigS1B

```



### **2d. Plotting drinking consumption by sex and ethnicity**

```{r}
total.drink.L.F <- subset(water.c.demo, SEX == "F")
median(total.drink.L.F$total.drink.L)

total.drink.L.M <- subset(water.c.demo, SEX == "M")
median(total.drink.L.M$total.drink.L)

#Plotting sex as a violin plot
labels.sex <- setNames(c("Female", "Male", "NA"), c("F", "M", NA))

Fig2A <- ggplot(water.c.demo, aes(SEX, total.drink.L, fill = SEX)) + geom_violin() + theme_bw() + scale_y_continuous(limits = c(0, 6.2)) + scale_x_discrete(labels = labels.sex) + ylab("Daily water consumption from drinking (L)") + xlab("") + 
  scale_fill_brewer(palette = "Dark2") +
  annotate("text", x = 0.5, y = 6, label = c("A"), colour = "black", size = 8) +
  theme(legend.position="none") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=14)) +
  geom_segment(aes(x = 0.9, y = 2.275, xend = 1.1, yend = 2.275, linewidth = 1, colour = "#cc5500")) + geom_segment(aes(x = 1.9, y = 2.2, xend = 2.1, yend = 2.2, linewidth = 1, colour = "#006400")) + geom_hline(yintercept = 2.7, linetype="dashed")  + geom_hline(yintercept = 3.7, linetype="dashed") +  
  annotate("text", x = c(1.45, 2.3), y = c(0.75, 5.5), label = c("Recommended \n daily intake \n for women \n (2.7 L)", "Recommended \n daily intake \n for men  \n (3.7 L)")) +
  annotate('curve',x = 1.25,y = 1.42, yend = 2.65, xend = 1.2, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))  ) +
  annotate('curve', x = 2.45,y = 4.8, yend = 3.8, xend = 2.4, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))  )

Fig2A

pairwise.wilcox.test(water.c.demo$total.drink.L, water.c.demo$SEX)

effect.sex <- water.c.demo %>% wilcox_effsize(total.drink.L ~ SEX)


```

```{r, warning=FALSE}

#Drinking consumption by ethnicity
labels.ethnicity <- setNames(c("Asian British", "Black British", "Mixed Ethnicity", "Other Ethnic Group", "White", "NA"), c("Asian_AsianBritish", "Black_BlackBritish", "Other_Ethnic_Group", "Mixed_Ethnic_Group", "White", NA))

p4 <- ggplot(water.c.demo, aes(Ethnic_Origin, total.drink.L, fill=Ethnic_Origin)) + geom_boxplot() + theme_bw() + 
  scale_x_discrete(labels = labels.ethnicity) + ylab("Daily water consumption for drinking (L)") + xlab("") + 
  scale_fill_brewer(palette = "Set2") +
  theme(legend.position="none")

p4
```

```{r}

kruskal.test(total.drink.L ~ Ethnic_Origin,
  data = water.c.demo
)


dunnTest(total.drink.L ~ Ethnic_Origin,
  data = water.c.demo,
  method = "holm"
  )

#Drinking consumption by ethnicity: White vs racial minoritised in the UK
water.c.demo$Ethnic_Origin_Simple <- water.c.demo$Ethnic_Origin
water.c.demo$Ethnic_Origin_Simple <- recode(water.c.demo$Ethnic_Origin_Simple, "Asian_AsianBritish" = 'Racially minoritised (in the UK)', 
                                       "Black_BlackBritish" = 'Racially minoritised (in the UK)',
                                       "Mixed_Ethnic_Group" = 'Racially minoritised (in the UK)', 
                                        "Other_Ethnic_Group" = "Racially minoritised (in the UK)")

water.c.demo.noNA <- subset(water.c.demo, !is.na(Ethnic_Origin_Simple)) 
```

```{r}
total.drink.L.White <- subset(water.c.demo.noNA, Ethnic_Origin_Simple == "White")
median(total.drink.L.White$total.drink.L)

total.drink.L.RM <- subset(water.c.demo.noNA, Ethnic_Origin_Simple == "Racially minoritised (in the UK)")
median(total.drink.L.RM$total.drink.L)

#Ethnicity as a violin plot.
Fig2B <- ggplot(water.c.demo.noNA, aes(Ethnic_Origin_Simple, total.drink.L, fill=Ethnic_Origin_Simple)) + geom_violin() + theme_bw() + scale_y_continuous(limits = c(0, 6.2)) + scale_x_discrete(labels = labels.ethnicity) + ylab("") + xlab("") + geom_segment(aes(x = 0.9, y = 1.875, xend = 1.1, yend = 1.875, linewidth = 1, colour = "#cc5500")) + geom_segment(aes(x = 1.9, y = 2.275, xend = 2.1, yend = 2.275, linewidth = 1, colour = "#006400")) + 
  scale_fill_brewer(palette = "Dark2") +
  annotate("text", x = 0.5, y = 6, label = c("B"), colour = "black", size = 8) + theme(legend.position="none") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=14)) + geom_hline(yintercept = 2.7, linetype="dashed")  + geom_hline(yintercept = 3.7, linetype="dashed") +  
  annotate("text", x = c(1.50, 2.3), y = c(0.75, 5.5), label = c("Recommended \n daily intake \n for women \n (2.7 L)", "Recommended \n daily intake \n for men  \n (3.7 L)")) +
  annotate('curve',x = 1.34,y = 1.32, yend = 2.65, xend = 1.2, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))  ) +
  annotate('curve', x = 2.45,y = 4.8, yend = 3.8, xend = 2.4, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))
  )


Fig2B


Fig2 <- ggarrange(Fig2A, Fig2B, nrow = 1)

```

```{r}
pairwise.wilcox.test(water.c.demo$total.drink.L, water.c.demo$Ethnic_Origin_Simple)

stat.test <- water.c.demo %>% 
  wilcox_test(total.drink.L ~ Ethnic_Origin_Simple) %>%
  add_significance()
stat.test

effect.ethnic <- water.c.demo %>% wilcox_effsize(total.drink.L ~ Ethnic_Origin_Simple)

```

### **2e. Plotting consumption from cooking by sex**

```{r}
total.cooking.L.noNA <- subset(water.c.demo, !is.na(total.cooking.L)) 

total.cooking.L.F <- subset(total.cooking.L.noNA, SEX == "F")
median(total.cooking.L.F$total.cooking.L)
mean(total.cooking.L.F$total.cooking.L)
```

```{r}

total.cook.L.M <- subset(total.cooking.L.noNA, SEX == "M")
median(total.cook.L.M$total.cooking.L)
mean(total.cook.L.M$total.cooking.L)

#Plot cooking by sex as violin plot
FigS5 <- ggplot(water.c.demo, aes(SEX, total.cooking.L, fill = SEX)) + geom_violin() + theme_bw() + scale_y_continuous(limits = c(0,0.4)) + scale_x_discrete(labels = labels.sex) + ylab("Daily water consumption from cooking (L)") + xlab("") + theme(legend.position="none") +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=14)) +
  geom_segment(aes(x = 0.9, y = 0.1, xend = 1.1, yend = 0.1, linewidth = 1, colour = "#cc5500")) + geom_segment(aes(x = 1.9, y = 0.1, xend = 2.1, yend = 0.1, linewidth = 1, colour = "#006400")) 

FigS5

```




### **2f. Plotting total consumption by sex**
```{r}
total.consump.L.noNA <- subset(water.c.demo, !is.na(total.consump.L)) 

total.consump.L.F <- subset(total.consump.L.noNA, SEX == "F")
median(total.consump.L.F$total.consump.L)
mean(total.consump.L.F$total.consump.L)

total.consump.L.M <- subset(total.consump.L.noNA, SEX == "M")
median(total.consump.L.M$total.consump.L)
mean(total.consump.L.M$total.consump.L)

#Total consumption by sex as a violin plot. Updated medians for 3 sd filtered values. 
labels.sex <- setNames(c("Female", "Male", "NA"), c("F", "M", NA))

FigS6 <- ggplot(water.c.demo, aes(SEX, total.consump.L, fill = SEX)) + geom_violin() + theme_bw() + scale_y_continuous(limits = c(0, 6.2)) + scale_x_discrete(labels = labels.sex) + ylab("Total daily tap water consumption within the home (L)") + xlab("") + 
  scale_fill_brewer(palette = "Dark2") +
  #annotate("text", x = 0.5, y = 6, label = c("C"), colour = "black", size = 8) +
  theme(legend.position="none") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=14)) +
  geom_segment(aes(x = 0.9, y = 2.4, xend = 1.1, yend = 2.4, linewidth = 1, colour = "#cc5500")) + geom_segment(aes(x = 1.9, y = 2.25, xend = 2.1, yend = 2.25, linewidth = 1, colour = "#006400")) + geom_hline(yintercept = 2.7, linetype="dashed")  + geom_hline(yintercept = 3.7, linetype="dashed") +  
  annotate("text", x = c(1.45, 2.4), y = c(0.75, 5.5), label = c("Recommended \n daily intake \n for women \n (2.7 L)", "Recommended \n daily intake \n for men  \n (3.7 L)")) +
  annotate('curve',x = 1.25,y = 1.42, yend = 2.65, xend = 1.2, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))  ) +
  annotate('curve', x = 2.45,y = 4.8, yend = 3.8, xend = 2.4, linewidth = 0.8, curvature = -0.4, arrow = arrow(length = unit(0.5, 'cm'))  )

FigS6


#Percentage of males and females who consume at home more than their respective recommended daily intake
#Female
total.consump.L.female <- subset(water.c.demo, water.c.demo$SEX == "F")
dim(total.consump.L.female)
sum(total.consump.L.female$total.consump.L < "2.7", na.rm=TRUE) #US National Academy value
sum(total.consump.L.female$total.consump.L >= "2.7", na.rm=TRUE) #US National Academy 
sum(total.consump.L.female$total.consump.L < "2", na.rm=TRUE) #EU Food Safety Authority 
sum(total.consump.L.female$total.consump.L >= "2", na.rm=TRUE) #EU Food Safety Authority 

#value
(945/2415)*100 #percentage of females equal or above 2.7L
(1563/2415)*100 #percentage of females equal or above 2L

total.consump.L.male <- subset(water.c.demo, water.c.demo$SEX == "M")
dim(total.consump.L.male)
sum(total.consump.L.male$total.consump.L < "3.7", na.rm=TRUE) #US National Academy value
sum(total.consump.L.male$total.consump.L >= "3.7", na.rm=TRUE) #US National Academy value
sum(total.consump.L.male$total.consump.L < "2.5", na.rm=TRUE) #EU Food Safety Authority 
sum(total.consump.L.male$total.consump.L >= "2.5", na.rm=TRUE) #EU Food Safety Authority 

#value
(25/295)*100
(116/295)*100
```




### **2g. Water consumption for drinking by age**

```{r}

 ggplot(water.c.demo, aes(age.gr, total.drink.L, fill=age.gr)) + geom_boxplot() + theme_minimal() + 
   ylab("Daily water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Set2")
```
 
```{r}
 
pairwise.wilcox.test(water.c.demo$total.drink.L, water.c.demo$age.gr)


pairwise.wilcox.test(water.c.demo$total.consump.L, water.c.demo$age.gr)


```


### **2h. Water consumption for drinking by sex and age**

```{r}
FigS4 <- ggplot(water.c.demo, aes(age.gr, total.drink.L, fill=SEX)) + geom_boxplot(outlier.shape = NA) + theme_bw() + scale_x_discrete(labels = labels.Age) + scale_y_continuous(limits = c(-0.6, 6.5)) +
  xlab("Daily tap water consumption for drinking (L)") +
  ylab("Daily water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Dark2") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.position = c(0.1, 0.85), legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
 stat_compare_means(aes(label = paste0("p = ", round(..p.., 2))),
                     method = "wilcox.test", label.y = -0.5)

FigS4

total.drink.L.over65 <- subset(water.c.demo, water.c.demo$age.gr == "3.Over 65")
total.drink.L.45.65 <- subset(water.c.demo, water.c.demo$age.gr == "2. 45 - 65")
total.drink.L.under45 <- subset(water.c.demo, water.c.demo$age.gr == "1. Under 45")

pairwise.wilcox.test(total.drink.L.over65$total.drink.L, total.drink.L.over65$SEX)
pairwise.wilcox.test(total.drink.L.45.65$total.drink.L, total.drink.L.45.65$SEX)
pairwise.wilcox.test(total.drink.L.under45$total.drink.L, total.drink.L.under45$SEX)

over65.sex <- pairwise.wilcox.test(total.drink.L.over65$total.drink.L, total.drink.L.over65$SEX)

pairwise.wilcox.test(total.drink.L.45.65$total.drink.L, total.drink.L.45.65$SEX)
pairwise.wilcox.test(total.drink.L.under45$total.drink.L, total.drink.L.under45$SEX)

```

```{r}
ggplot(water.c.demo.noNA, aes(age.gr, total.drink.L, fill=Ethnic_Origin_Simple)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(-0.6, 6.5)) +
  xlab("Daily tap water consumption for drinking (L)") +
  ylab("Daily water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Dark2") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.position = c(0.1, 0.85), legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
 stat_compare_means(aes(label = paste0("p = ", ..p.format..)),
                     method = "wilcox.test", label.y = -0.5)


total.drink.L.over65 <- subset(water.c.demo, water.c.demo$age.gr == "3.Over 65")
total.drink.L.45.65 <- subset(water.c.demo, water.c.demo$age.gr == "2. 45 - 65")
total.drink.L.under45 <- subset(water.c.demo, water.c.demo$age.gr == "1. Under 45")

pairwise.wilcox.test(total.drink.L.over65$total.drink.L, total.drink.L.over65$SEX)
pairwise.wilcox.test(total.drink.L.45.65$total.drink.L, total.drink.L.45.65$SEX)
pairwise.wilcox.test(total.drink.L.under45$total.drink.L, total.drink.L.under45$SEX)


```



```{r}
pairwise.wilcox.test(water.c.demo$total.drink.L, water.c.demo$SEX)
```
```{r #Add education, IMD and employment}
#aa <- read.csv(###Add csv file of education and IMD data. File name removed for security.)

edu <- aa[c("sn", "edu_bin_combined", "edu_cat_combined", "imd_decile_combined")]
edu <- edu %>% rename_at('sn', ~'study_no')

water.c.demo <- left_join(water.c.demo, edu, by="study_no")

###Test IMD
total.consump.L.IMD.7 <- subset(water.c.demo, imd_decile_combined > "7")
total.consump.L.IMD.7 <- subset(water.c.demo, imd_decile_combined < "3")

IMD.tercile <- quantile(water.c.demo$imd_decile_combined, probs=c(1/3,2/3,1), na.rm = TRUE)

IMD.tercile <- quantile(water.c.demo$imd_decile_combined, probs=c(1/4,1/2,3/4,1), na.rm = TRUE)

water.c.demo$IMD.group1 <- ifelse(water.c.demo$imd_decile_combined>=9,"3.9+",
                    ifelse(water.c.demo$imd_decile_combined>=6, "2.6-9",
                           ifelse(water.c.demo$imd_decile_combined<6, "1.Under6",NA)))

water.c.demo$IMD.group2 <- ifelse(water.c.demo$imd_decile_combined>=7,"3.7+",
                    ifelse(water.c.demo$imd_decile_combined>=4, "2.4-7",
                           ifelse(water.c.demo$imd_decile_combined<4, "1.Under4",NA)))

water.c.demo$IMD.group1 <- as.factor(water.c.demo$IMD.group1)
water.c.demo$IMD.group2 <- as.factor(water.c.demo$IMD.group2)
table(water.c.demo$IMD.group1)
table(water.c.demo$IMD.group2)

kruskal.test(total.drink.L ~ IMD.group1, data = water.c.demo)
pairwise.wilcox.test(water.c.demo$total.drink.L, water.c.demo$IMD.group1)

###Test education
water.c.demo$edu_bin_combined <- as.factor(water.c.demo$edu_bin_combined)
table(water.c.demo$edu_bin_combined)

kruskal.test(total.drink.L ~ edu_bin_combined, data = water.c.demo)
pairwise.wilcox.test(water.c.demo$total.drink.L, water.c.demo$edu_bin_combined)


#Add and test employment
### Ruth will add in cope data for easy employment status
# cope1 <- read.csv("C:/Users/Ruth/OneDrive - King's College London/Working_projects/Cope.Cleaning/Data/Cope1.Cleaned/Cope1.Clean.05.10.21.csv")
# employ <- cope1[c("study_no", "E97")]
# 
# water.c.demo <- left_join(water.c.demo, employ, by="study_no")
# 
# #1	Employed
# #2	Self-eployed
# #3	In unpaid/ voluntary work
# #4	Apprenticeship
# #5	Unemployed
# #6	Permanently sick or disabled
# #7	Looking after home or family
# #8	In education at school/college/university, or in an apprenticeship
# #9	Retired
# #10 
# 
# x <- water.c.demo$E97
# 
# 
# water.c.demo$employment.status <- ifelse(x==9|x<8&x>4, "Retired, Unemployed, Carer, LT Sick", 
#                                          ifelse(is.na(x), NA, "Employed, Education etc"))
# 
# table(water.c.demo$employment.status, useNA="ifany")


```

 
### **2i. Do people who like the taste of their water drink more? (Question 8)**

```{r }
q7_8 <- as.data.frame(apply(df.q[c("q7" , "q8")],2,function(x){
  x <- as.factor(x)
  levels(x) <- c("1. Strongly disagree", "2. Disgree", "3. Neither agree/disagree", "4. Agree", "5. Strongly Agree", NA)
  return(x)
}))

q5.filt <- df.q[c("q5")]

water.c.demo <- cbind(water.c.demo, q7_8, q5.filt)


#Do people who like their water drink more?
Fig3A <- ggplot(subset(water.c.demo, !is.na(q8)), aes(q8, total.drink.L, fill=q8)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 8.5), breaks = c(0, 2, 4, 6), labels = c(0, 2, 4, 6)) +
  ylab("Daily drinking water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 8.2, label = c("I like the taste of the \n unfiltered tap water in my home"), size = 6) +   annotate("text", x = 0.75, y = 8.4, label = c("A"), colour = "black", size = 8) 

Fig3A

m.q8 <- compare_means(total.drink.L ~ q8, data = water.c.demo, method = "wilcox.test")
#Add significance stars
Fig3A <- Fig3A + stat_pvalue_manual(m.q8, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)
```

```{r}

pairwise.wilcox.test(water.c.demo$total.drink.L, water.c.demo$q8)

kruskal.test(total.drink.L ~ q8,
  data = water.c.demo
)

dunnTest(total.drink.L ~ q8,
  data = water.c.demo,
  method = "holm"
  )

#Calculating the numbers
strongly.dislike.water <- subset(water.c.demo, q8 == "1. Strongly disagree")
dislike.water <- subset(water.c.demo, q8 == "2. Disgree")
like.water <- subset(water.c.demo, q8 == "4. Agree")
strongly.like.water <- subset(water.c.demo, q8 == "5. Strongly Agree") 

Water.Median.1 <- median(strongly.dislike.water$total.drink.L, na.rm = T)
Water.Mean.1 <- mean(strongly.dislike.water$total.drink.L, na.rm = T)
Water.SD.1 <- sd(strongly.dislike.water$total.drink.L, na.rm = T)
Water.Median.2 <- median(dislike.water$total.drink.L, na.rm = T)
Water.Mean.2 <- mean(dislike.water$total.drink.L, na.rm = T)
Water.SD.2 <- sd(dislike.water$total.drink.L, na.rm = T)
Water.Median.3 <- median(like.water$total.drink.L, na.rm = T)
Water.Mean.3 <- mean(like.water$total.drink.L, na.rm = T)
Water.SD.3 <- sd(like.water$total.drink.L, na.rm = T)
Water.Median.4 <- median(strongly.like.water$total.drink.L, na.rm = T)
Water.Mean.4 <- mean(strongly.like.water$total.drink.L, na.rm = T)
Water.SD.5 <- sd(strongly.like.water$total.drink.L, na.rm = T)

#Do people with a favourable view / non-favourable view of taste of their water
dim(strongly.dislike.water)
sum(strongly.dislike.water$total.consump.L >= "2.7", na.rm=TRUE) #US National Academy 
sum(strongly.dislike.water$total.consump.L >= "2", na.rm=TRUE) #EU Food Safety Authority 
dim(dislike.water)
sum(dislike.water$total.consump.L >= "2.7", na.rm=TRUE) #US National Academy 
sum(dislike.water$total.consump.L >= "2", na.rm=TRUE) #EU Food Safety Authority 

((43+84)/(137+277))*100 #percentage of dislike/strong dislike equal or above 2.7L
((75+153)/(137+277))*100 #percentage of dislike/strong dislike equal or above 2L

dim(strongly.like.water)
sum(strongly.like.water$total.consump.L >= "2.7", na.rm=TRUE) #US National Academy 
sum(strongly.like.water$total.consump.L >= "2", na.rm=TRUE) #EU Food Safety Authority 
dim(like.water)
sum(like.water$total.consump.L >= "2.7", na.rm=TRUE) #US National Academy 
sum(like.water$total.consump.L >= "2", na.rm=TRUE) #EU Food Safety Authority 

((187+385)/(276+973))*100 #percentage of like/strong like equal or above 2.7L
((276+656)/(276+973))*100 #percentage of like/strong like equal or above 2L



#Are people who don't consume any drinks from their tap more averse to the taste of their water?
qs.filt <- df.q[c("q2_a", "q2_b", "q2_d", "q2_e")]

number.drinks <- cbind(water.c.demo, qs.filt)

zero.drinks <- subset(number.drinks, q2_a == "0" & q2_b == "0" & q2_d == "0" & q2_e == "0")
some.drinks <- subset(number.drinks, q2_a > "0" | q2_b > "0" | q2_d > "0" | q2_e > "0")

s1 <- sum(zero.drinks$q8 == "1. Strongly disagree", na.rm=TRUE)
s2 <- sum(zero.drinks$q8 == "2. Disgree", na.rm=TRUE)
s3 <- sum(zero.drinks$q8 == "3. Neither agree/disagree", na.rm=TRUE)
s4 <- sum(zero.drinks$q8 == "4. Agree", na.rm=TRUE)
s5 <- sum(zero.drinks$q8 == "5. Strongly Agree", na.rm=TRUE)
s <- s1+s2+s3+s4+s5
#% disagree or strongly disagree 47%
(s1 + s2) / s * 100

s1 <- sum(some.drinks$q8 == "1. Strongly disagree", na.rm=TRUE)
s2 <- sum(some.drinks$q8 == "2. Disgree", na.rm=TRUE)
s3 <- sum(some.drinks$q8 == "3. Neither agree/disagree", na.rm=TRUE)
s4 <- sum(some.drinks$q8 == "4. Agree", na.rm=TRUE)
s5 <- sum(some.drinks$q8 == "5. Strongly Agree", na.rm=TRUE)
s <- s1+s2+s3+s4+s5
#% disagree or strongly disagree 14.5%
(s1 + s2) / s * 100
```

```{r Taste by sex}
total.drink.L.female <- subset(water.c.demo, water.c.demo$SEX == "F")

FigS7A <- ggplot(subset(total.drink.L.female, !is.na(q8)), aes(q8, total.drink.L, fill=q8)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 11), breaks = c(0, 2, 4, 6)) + ylab("Daily drinking water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 10.2, label = c("I like the taste of the \n unfiltered tap water in my home \n (female respondents)"), size = 6) +
  annotate("text", x = 0.75, y = 11, label = c("A"), size = 8)

m.q8.female <- compare_means(total.drink.L ~ q8, data = total.drink.L.female, method = "wilcox.test")
#Add significance stars
FigS7A <- FigS7A + stat_pvalue_manual(m.q8.female, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.female$total.drink.L, total.drink.L.female$q8)

total.drink.L.male <- subset(water.c.demo, water.c.demo$SEX == "M")

FigS7B <- ggplot(subset(total.drink.L.male, !is.na(q8)), aes(q8, total.drink.L, fill=q8)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 11), breaks = c(0, 2, 4, 6)) + ylab("") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 10.2, label = c("I like the taste of the \n unfiltered tap water in my home \n (male respondents)"), size = 6) +
  annotate("text", x = 0.75, y = 11, label = c("B"), size = 8)

m.q8.male <- compare_means(total.drink.L ~ q8, data = total.drink.L.male, method = "wilcox.test")
#Add significance stars
FigS7B <- FigS7B + stat_pvalue_manual(m.q8.male, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.male$total.drink.L, total.drink.L.male$q8)

FigS7 <- ggarrange(FigS7A, FigS7B, nrow = 1, common.legend = TRUE, legend = "bottom")

```

```{r Taste by age}
total.drink.L.over65 <- subset(water.c.demo, water.c.demo$age.gr == "3.Over 65")
total.drink.L.45.65 <- subset(water.c.demo, water.c.demo$age.gr == "2. 45 - 65")
total.drink.L.under45 <- subset(water.c.demo, water.c.demo$age.gr == "1. Under 45")

#under45
FigS8A <- ggplot(subset(total.drink.L.under45, !is.na(q8)), aes(q8, total.drink.L, fill=q8)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 7.8), breaks = c(0, 2, 4, 6)) + ylab("Daily drinking water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 7.4, label = c("I like the taste of the \n unfiltered tap water in my home \n (Under 45)"), size = 5.6) +
  annotate("text", x = 0.75, y = 7.8, label = c("A"), size = 8)

m.q8.u45 <- compare_means(total.drink.L ~ q8, data = total.drink.L.under45, method = "wilcox.test")
#Add significance stars
FigS8A <- FigS8A + stat_pvalue_manual(m.q8.u45, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 6, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.under45$total.drink.L, total.drink.L.under45$q8)

#45 to 65                                                                                                   
FigS8B <- ggplot(subset(total.drink.L.45.65, !is.na(q8)), aes(q8, total.drink.L, fill=q8)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 7.8), breaks = c(0, 2, 4, 6)) + ylab("Daily drinking water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 7.4, label = c("I like the taste of the \n unfiltered tap water in my home \n (45-65)"), size = 6) +
  annotate("text", x = 0.75, y = 7.8, label = c("B"), size = 8)

m.q8.45.65 <- compare_means(total.drink.L ~ q8, data = total.drink.L.45.65, method = "wilcox.test")
#Add significance stars
FigS8B <- FigS8B + stat_pvalue_manual(m.q8.45.65, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.45.65$total.drink.L, total.drink.L.45.65$q8)
                                                                                                                
#over65
FigS8C <- ggplot(subset(total.drink.L.over65, !is.na(q8)), aes(q8, total.drink.L, fill=q8)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 7.8), breaks = c(0, 2, 4, 6)) + ylab("Daily drinking water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 7.4, label = c("I like the taste of the \n unfiltered tap water in my home \n (Over 65)"), size = 6) +
  annotate("text", x = 0.75, y = 7.8, label = c("C"), size = 8)

m.q8.over65 <- compare_means(total.drink.L ~ q8, data = total.drink.L.45.65, method = "wilcox.test")
#Add significance stars
FigS8C <- FigS8C + stat_pvalue_manual(m.q8.over65, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.over65$total.drink.L, total.drink.L.over65$q8)

FigS8 <- ggarrange(FigS8A, FigS8B, FigS8C, ncol = 1, common.legend = TRUE, legend = "bottom")

```

### **2j. Do people who consider tap water to be good for health drink more? (Question 7)**

```{r, warning = F}
#Do people who consider tap water to be good for health drink more?
Fig3B <- ggplot(subset(water.c.demo, !is.na(q7)), aes(q7, total.drink.L, fill=q7)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 8.5), breaks = c(0, 2, 4, 6), labels = c(0, 2, 4, 6)) +
  ylab("Daily water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_blank()) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 8.2, label = c("Drinking tap water in the UK \n is good for my health"), size = 6) + 
  annotate("text", x = 0.75, y = 8.4, label = c("B"), colour = "black", size = 8)

m.q7 <- compare_means(total.drink.L ~ q7, data = water.c.demo, method = "wilcox.test")
#Add significance stars
Fig3B <- Fig3B + stat_pvalue_manual(m.q7, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

Fig3 <- ggarrange(Fig3A, Fig3B, nrow = 1, common.legend = TRUE, legend = "bottom")


#What proportion of people with a favourable view / non-favourable view of health benefits of their water dirnk more than international guidelines
strongly.disagree.health <- subset(water.c.demo, q7 == "1. Strongly disagree")
disagree.health <- subset(water.c.demo, q7 == "2. Disgree")
agree.health <- subset(water.c.demo, q7 == "4. Agree")
strongly.agree.health <- subset(water.c.demo, q7 == "5. Strongly Agree") 

dim(strongly.disagree.health)
sum(strongly.disagree.health$total.consump.L >= "2.7", na.rm=TRUE) #US National Academy 
sum(strongly.disagree.health$total.consump.L >= "2", na.rm=TRUE) #EU Food Safety Authority
dim(disagree.health)
sum(disagree.health$total.consump.L >= "2.7", na.rm=TRUE) #US National Academy 
sum(disagree.health$total.consump.L >= "2", na.rm=TRUE) #EU Food Safety Authority 

((17+19)/(62+76))*100 #percentage of dislike/strong dislike equal or above 2.7L
((33+41)/(62+76))*100 #percentage of dislike/strong dislike equal or above 2L

dim(strongly.agree.health)
sum(strongly.agree.health$total.consump.L >= "2.7", na.rm=TRUE) #US National Academy 
sum(strongly.agree.health$total.consump.L >= "2", na.rm=TRUE) #EU Food Safety Authority
dim(agree.health)
sum(agree.health$total.consump.L >= "2.7", na.rm=TRUE) #US National Academy 
sum(agree.health$total.consump.L >= "2", na.rm=TRUE) #EU Food Safety Authority 

((272+435)/(596+1127))*100 #percentage of like/strong like equal or above 2.7L
((422+758)/(276+973))*100 #percentage of like/strong like equal or above 2L


```

```{r}

pairwise.wilcox.test(water.c.demo$total.drink.L, water.c.demo$q7)

kruskal.test(total.drink.L ~ q7,
  data = water.c.demo
)

dunnTest(total.drink.L ~ q7,
  data = water.c.demo,
  method = "holm"
  )
```


```{r health benefits by sex}
total.drink.L.female <- subset(water.c.demo, water.c.demo$SEX == "F")

FigS9A <- ggplot(subset(total.drink.L.female, !is.na(q7)), aes(q7, total.drink.L, fill=q7)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 11), breaks = c(0, 2, 4, 6)) + ylab("Daily drinking water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 10.2, label = c("Drinking tap water in the UK \n is good for my health \n (female respondents)"), size = 6) +
  annotate("text", x = 0.75, y = 11, label = c("A"), size = 8)

m.q7.female <- compare_means(total.drink.L ~ q7, data = total.drink.L.female, method = "wilcox.test")
#Add significance stars
FigS9A <- FigS9A + stat_pvalue_manual(m.q7.female, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.female$total.drink.L, total.drink.L.female$q7)

total.drink.L.male <- subset(water.c.demo, water.c.demo$SEX == "M")

FigS9B <- ggplot(subset(total.drink.L.male, !is.na(q7)), aes(q7, total.drink.L, fill=q7)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 11), breaks = c(0, 2, 4, 6)) + ylab("") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 10.2, label = c("Drinking tap water in the UK \n is good for my health \n (male respondents)"), size = 6) +
  annotate("text", x = 0.75, y = 11, label = c("B"), size = 8)

m.q7.male <- compare_means(total.drink.L ~ q7, data = total.drink.L.male, method = "wilcox.test")
#Add significance stars
FigS9B <- FigS9B + stat_pvalue_manual(m.q7.male, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.male$total.drink.L, total.drink.L.male$q7)

FigS9 <- ggarrange(FigS9A, FigS9B, nrow = 1, common.legend = TRUE, legend = "bottom")
```


```{r Health benefits by age}
total.drink.L.over65 <- subset(water.c.demo, water.c.demo$age.gr == "3.Over 65")
total.drink.L.45.65 <- subset(water.c.demo, water.c.demo$age.gr == "2. 45 - 65")
total.drink.L.under45 <- subset(water.c.demo, water.c.demo$age.gr == "1. Under 45")

#under45
FigS10A <- ggplot(subset(total.drink.L.under45, !is.na(q7)), aes(q7, total.drink.L, fill=q7)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 7.8), breaks = c(0, 2, 4, 6)) + ylab("Daily drinking water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 7.4, label = c("Drinking tap water in the UK \n is good for my health \n (Under 45)"), size = 5.6) +
  annotate("text", x = 0.75, y = 7.8, label = c("A"), size = 8)

m.q7.u45 <- compare_means(total.drink.L ~ q7, data = total.drink.L.under45, method = "wilcox.test")
#Add significance stars
FigS10A <- FigS10A + stat_pvalue_manual(m.q8.u45, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 6, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.under45$total.drink.L, total.drink.L.under45$q7)

#45 to 65                                                                                                   
FigS10B <- ggplot(subset(total.drink.L.45.65, !is.na(q7)), aes(q7, total.drink.L, fill=q7)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 7.8), breaks = c(0, 2, 4, 6)) + ylab("Daily drinking water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 7.4, label = c("Drinking tap water in the UK \n is good for my health \n (45-65)"), size = 6) +
  annotate("text", x = 0.75, y = 7.8, label = c("B"), size = 8)

m.q7.45.65 <- compare_means(total.drink.L ~ q7, data = total.drink.L.45.65, method = "wilcox.test")
#Add significance stars
FigS10B <- FigS10B + stat_pvalue_manual(m.q7.45.65, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.45.65$total.drink.L, total.drink.L.45.65$q7)
                                                                                                                
#over65
FigS10C <- ggplot(subset(total.drink.L.over65, !is.na(q7)), aes(q7, total.drink.L, fill=q7)) + geom_boxplot(outlier.shape = NA) + theme_bw() +     scale_y_continuous(limits = c(0, 7.8), breaks = c(0, 2, 4, 6)) + ylab("Daily drinking water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", NA)) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) +
  #theme(plot.title=element_text(family='', face='bold', colour='green', size=26, margin=margin(t=40,b=-30)))
  annotate("text", x = 3, y = 7.4, label = c("Drinking tap water in the UK \n is good for my health \n (Over 65)"), size = 6) +
  annotate("text", x = 0.75, y = 7.8, label = c("C"), size = 8)

m.q7.over65 <- compare_means(total.drink.L ~ q7, data = total.drink.L.45.65, method = "wilcox.test")
#Add significance stars
FigS10C <- FigS10C + stat_pvalue_manual(m.q7.over65, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

pairwise.wilcox.test(total.drink.L.over65$total.drink.L, total.drink.L.over65$q7)

FigS10 <- ggarrange(FigS10A, FigS10B, FigS10C, ncol = 1, common.legend = TRUE, legend = "bottom")

```



### **2k. Unusual visual appearance**

```{r}
q10 <- df.q[c("q10")]

df.q10 <- as.data.frame(q10)

water.visual.concerns <- cbind(water.c.demo, q10)

q10.yes <- sum(q10 == "1", na.rm=TRUE)
q10.no <- sum(q10 == "0", na.rm=TRUE)

#percentage who consider their tap water to be unusual in appearance at least once a year
q10.perc <- (q10.yes/q10.no)*100

q10s <- as.data.frame(apply(q10,2, function(x){
  x <- as.factor(x)
  levels(x) <-  c("Never/ It always looks the same", "Once or twice a year", "A few times a year", "Monthly", "Weekly", NA)
  return(x)
}))

q10s <- q10s %>% 
    mutate(q10 = q10 %>% fct_relevel("Weekly", "Monthly", "A few times a year", "Once or twice a year",  "Never/ It always looks the same"))

ggplot(q10s, aes(y = q10)) +
    geom_bar(stat = "count") +
    theme_bw() + 
    ylab('How often do respondents consider their water to be unusual in appearance') +
    xlab('Number of respondents')  

#Summarise how often
visual.responses <- table(q10s$q10)
total.responses <- sum(visual.responses)
visual.responses.percentages <- (visual.responses / total.responses) * 100

#How often
howoften.long <- pivot_longer(
    q10s, 
    cols = `q10`, 
      names_to = "Question",
      values_to = "How_often", 
    cols_vary = "slowest",
      ) 
```
```{r warning = F}
#Stacked bar chart of q10 responses about unusual visual appearance
# ppp3 <- ggplot(subset(howoften.long, !is.na(How_often)), aes(x = Question, fill = How_often)) + 
#     geom_bar() +
#     scale_fill_viridis_d(direction = -1, labels = c("Weekly", "Monthly", "A few times a year",  "Once or twice a year", "Never / it always looks the same")) +
#     theme_bw() +
#     ylab("Number of responses") +
#     xlab("") +
#     scale_x_discrete(labels = "How often is your water unusual in appearance") +
#    guides(fill = guide_legend(title = ""))

```

```{r warning = F}

# #Percentages
# ppp4 <- ggplot(subset(howoften.long, !is.na(How_often)), aes(x = Question, fill = How_often)) + 
#     geom_bar(position = "fill") +
#     scale_fill_viridis_d(direction = -1, labels = c("Strongly disagree", "Disagree", "Neither agree nor disagree", "Agree", "Strongly Agree", "Fixed tariff", "")) +
#     theme_bw() +
#     ylab("Number of responses (%)") +
#     xlab("") +
#     scale_x_discrete(labels = "How often is your water unusual in appearance") +
#    guides(fill = guide_legend(title = ""))
# 
# p10 <- ggarrange(ppp3, ppp4, ncol = 2, nrow = 1, common.legend = TRUE)
# 
# p10
```

```{r}
water.c.demo.q10s <- cbind(water.c.demo, q10s)
water.c.demo.q10s <- as.data.frame(water.c.demo.q10s)

#Question 10 - unusual appearance vs drinking 
Fig4 <- ggplot(subset(water.c.demo.q10s, !is.na(q10)), aes(q10, total.drink.L, fill=q10)) + 
  geom_boxplot(outlier.shape = NA) + theme_bw() + scale_y_continuous(limits = c(0, 6.5)) +
  ylab("Daily drinking tap water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Weekly", "Monthly", "A few times a year", "Once or twice a year", "Never / It always looks the same")) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) + annotate("text", x = 3, y = 6.2, label = c("How often is the tap water in my home \n unusual in appearance"), size = 6) #+ 
  #annotate("text", x = 0.65, y = 7.4, label = c("A"), colour = "black", size = 8)

m.q10.drink <- compare_means(total.drink.L ~ q10, data = water.c.demo.q10s, method = "wilcox.test")
#Add significance stars
Fig4 <- Fig4 + stat_pvalue_manual(m.q10.drink, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = -0.04, tip.length = 0.01)

Fig4

```

```{r warning = F}
pairwise.wilcox.test(water.c.demo.q10s$total.drink.L, water.c.demo.q10s$q10)

kruskal.test(total.drink.L ~ q10,
  data = water.c.demo.q10s
)

dunnTest(total.drink.L ~ q10,
  data = water.c.demo.q10s,
  method = "holm"
  )

```


```{r}

#Question 10 - unusual appearance vs total consumption (drinking + cooking)
FigS13 <- ggplot(subset(water.c.demo.q10s, !is.na(q10)), aes(q10, total.consump.L, fill=q10)) + 
  geom_boxplot(outlier.shape = NA) + theme_bw() + scale_y_continuous(limits = c(0, 7.5)) +
  ylab("Daily total tap water consumption (L)") + xlab("") + scale_fill_brewer(palette = "Spectral", labels = c("Weekly", "Monthly", "A few times a year", "Once or twice a year", "Never / It always looks the same")) +  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y = element_text(margin = margin(r=15))) +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  theme(legend.title = element_blank(), legend.key.size = unit(1.5, "cm"), legend.text = element_text(size = 12)) + 
  annotate("text", x = 3, y = 7.2, label = c("How often is the tap water in my home \n unusual in appearance"), size = 6) #

m.q10 <- compare_means(total.consump.L ~ q10, data = water.c.demo.q10s, method = "wilcox.test")
#Add significance stars
FigS13 <- FigS13 + stat_pvalue_manual(m.q10, label = "p.signif", inherit.aes = FALSE, hide.ns = TRUE, y.position = 5.5, step.increase = 0.04, tip.length = 0.01)

FigS13

#Fig4 <- ggarrange(Fig4A, Fig4B, nrow = 1, common.legend = TRUE, legend = "bottom")


```

```{r}

pairwise.wilcox.test(water.c.demo.q10s$total.consump.L, water.c.demo.q10s$q10)

kruskal.test(total.consump.L ~ q10,
  data = water.c.demo.q10s
)

dunnTest(total.consump.L ~ q10,
  data = water.c.demo.q10s,
  method = "holm"
  )

```

```{r eval=FALSE, include=FALSE}

#Question 11 - in what way did your water have an unusual appearance?
q11 <- df.q[c("q11_straw", "q11_brown", "q11_blue", "q11_black", "q11_cloudy", "q11_stains", "q11_bits", "q11_unsure")]

#What percentage of respondents had water with each unusual characteristic? 
straw.sum <- sum(q11$q11_straw == "1", na.rm=TRUE)
straw.perc <- straw.sum/2710*100
brown.sum <- sum(q11$q11_brown == "1", na.rm=TRUE)
brown.perc <- brown.sum/2710*100
blue.sum <- sum(q11$q11_blue == "1", na.rm=TRUE)
blue.perc <- blue.sum/2710*100
black.sum <- sum(q11$q11_black == "1", na.rm=TRUE)
black.perc <- black.sum/2710*100
cloudy.sum <- sum(q11$q11_cloudy == "1", na.rm=TRUE)
cloudy.perc <- cloudy.sum/2710*100
stains.sum <- sum(q11$q11_stains == "1", na.rm=TRUE)
stains.perc <- stains.sum/2710*100
bits.sum <- sum(q11$q11_bits == "1", na.rm=TRUE)
bits.perc <- bits.sum/2710*100
unsure.sum <- sum(q11$q11_unsure == "1", na.rm=TRUE)
unsure.perc <- unsure.sum/2710*100
q11.response <- cbind(straw.sum, brown.sum, blue.sum, black.sum, cloudy.sum, stains.sum, bits.sum, unsure.sum)
q11.responses.df <- as.data.frame(q11.response)
q11.perc <- cbind(straw.perc, brown.perc, blue.perc, black.perc, cloudy.perc, stains.perc, bits.perc, unsure.perc)
q11.perc.df <- as.data.frame(q11.perc)

q11.1 <- q11 %>% filter_all(any_vars(. %in% c('1')))

```
