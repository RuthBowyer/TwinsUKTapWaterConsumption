---
title: "TwinDiscordance"
author: "Ruth CE Bowyer"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  github_document:
    toc: true
    toc_depth: 3
---


```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = F, warning =F}
library(mets)
library(dplyr)
library(mets)
library(ggplot2)
library(viridis)
library(readxl)
```

## **1.Data**


```{r include=FALSE}
dd <- "~/Library/CloudStorage/OneDrive-King'sCollegeLondon/Working_projects/Tap.water/SharedDSRB/Data/I1194"

```



```{r data}

## Define the data directory -- actual directory omitted for security
#dd <- ~/path/to/data

df.q <- read_xlsx(paste0(dd,"/DS00070_WaterConsumptionStudy_Questionnaire/WaterConsumptionStudyQuestionnaire_Data.xlsx"))

#Response codes 
Responses <- read_xlsx(paste0(dd,"/DS00070_WaterConsumptionStudy_Questionnaire/WaterConsumptionStudyQuestionnaire_Data.xlsx"), sheet=2)

## Create a df with q code - row names qcode 
Qframe <- as.data.frame(t(df.q[1,]))
## Add col index for easy referencing
names(Qframe) <- "Question"
Qframe$col_index <- 1:ncol(df.q)

##Clean up df.q to remove these rows
df.q <- df.q[-1,]
df.q <- as.data.frame(df.q)


TDs <- read_excel(paste0(dd, "/TwinDetails.xlsx"))
water.consump <- read.csv(paste0(dd, "/water.consump.filter.2025.07.28.csv")) # File derived as output from script 1. This csv file has been filtered in Script 1. 

```



```{r}
## Clean data for NAs
df.q.filt <- merge(df.q, water.consump, by.x = "ParticipantID", by.y = "study_no")
df.q.filt <- merge(df.q.filt, TDs, by = "ParticipantID")
df.q.filt[c("q7", "q8")] <- apply(df.q.filt[c("q7", "q8")],2,function(i){
  i <- as.numeric(i)
  ifelse(i>900, NA,i)
})
### q7 and q8 
```

## **2. Paired discordance**

### Discordance for: *Do people who consider tap water to be good for health drink more? (Question 7)*


```{r}
df.q.filt <- df.q.filt[order(df.q.filt$q7),]

twinwide<- fast.reshape(df.q.filt, id="Family_No")
 
twinwide <- subset(twinwide, !is.na(ParticipantID2))

```

840 pairs where both have data 

```{r}

diff <- abs(twinwide$q71 - twinwide$q72)
discordsq7 <- subset(twinwide, diff > 1)
```

107 pairs discordant for Q7 (by 1 greater)
Twin2 have higher preference here (3,4or5)

```{r}
wilcox.test(discordsq7$total.consump.L1, discordsq7$total.consump.L2, paired=T)
```



### Discordance for: *Do people who like the taste of their water drink more? (Question 8)*

```{r}
df.q.filt <- df.q.filt[order(df.q.filt$q8),]

twinwide<- fast.reshape(df.q.filt, id="Family_No")
 
twinwide <- subset(twinwide, !is.na(ParticipantID2))

```


```{r}

diff <- abs(twinwide$q81 - twinwide$q82)
discordsq8 <- subset(twinwide, diff > 1)
```

178 pairs discordant for Q8 (by 1 greater )
Twin2 have higher preference here (3,4or5)

```{r}
wilcox.test(discordsq8$total.consump.L1, discordsq8$total.consump.L2, paired=T)
```

